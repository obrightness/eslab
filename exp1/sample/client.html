<!DOCTYPE html>
<title>Test Client Web Page</title>
<meta charset="utf-8">

<h3>留言板</h3>
<font size="2" color="#000000">留言者暱稱</font>
<input id="user-name" autofocus>
</br> </br>
<font size="2" color="#000000">留言內容 </font>
<input id="user-input" autofocus>
</br> </br>
<button id="submit-btn">Submit</button>
<button id="refresh-btn">Refresh</button>
</br> </br>

<table id="Table" style="boder-bottom-style:none;border-width:3px;border-style:dashed;border-color:#FFAC55">

<tr>
   <td bgcolor="#ffebcd" align="center" width="50%">
   <font size="2" color="#FFFFFF">時間</font>
   </td>

   <td bgcolor="#ffebcd" width="30%" align="center">
   <font size="2" color="#FFFFFF">留言人</font>
   </td>

   <td bgcolor="#ffebcd" align="center">
   <font size="2" color="#FFFFFF">留言</font>
   </td>
</tr>
</table>


<script>

var submitBtn = document.getElementById("submit-btn");
var refreshBtn = document.getElementById("refresh-btn");


var retrieveAllDataFromServer = function () {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'http://127.0.0.1:1234/retrieve');
  xhr.onload = function () {
    console.log('Got response of HTTP POST /retrieve:' +
        this.responseText);

    var JSON_string = this.responseText;
    var arr = JSON.parse(JSON_string);
    for (var i = 0, len = arr.length; i < len; i += 1) {
	var test = JSON.parse(arr[i]);
        
	   var table = document.getElementById("Table");
           var row = table.insertRow(i+1);
           var liTime = row.insertCell(0);
  	   var slitime = test.time.slice(0,24);
           liTime.innerHTML = slitime;
	   var liName = row.insertCell(1);
           liName.innerHTML = test.name;
           var liElm = row.insertCell(2);
           liElm.innerHTML = test.message;   
    }
  };
  xhr.send();
};

refreshBtn.addEventListener('click', function () {
  var num = document.getElementById("Table").rows.length;
  while(document.getElementById("Table").rows.length > 2){
    for(i = 1; i < num; i++){
      document.getElementById("Table").deleteRow(-1);
  }}
  retrieveAllDataFromServer();
});

retrieveAllDataFromServer();

var postDataToServer = function (data) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'http://127.0.0.1:1234/push');
  xhr.onload = function () {
    console.log('Got response of POST /push:' +
        this.responseText);
  };
  xhr.send(data);
};


submitBtn.addEventListener('click', function () {
  
  var msg = { 
	time: Date(),
	name: document.getElementById("user-name").value, 
        message: document.getElementById("user-input").value
  };
  console.log(msg);
  msg.message = msg.message.trim();
  msg.name = msg.name.trim();
  
  if (msg.name !== '' && msg.message !== '') {
  
    postDataToServer(JSON.stringify(msg));
    document.getElementById("user-input").value = '';
    document.getElementById("user-name").value = '';

 };
});

</script>
